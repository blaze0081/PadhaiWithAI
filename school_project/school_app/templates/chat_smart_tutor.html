{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PAI-AI Study Sathi, Tonk</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!-- MathJax for Mathematics Rendering -->
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          packages: { '[+]': ['ams'] },
        },
        options: {
          skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        },
        chtml: { scale: 1 },
        svg:   { scale: 1, fontCache: 'global' }
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <style>
        :root {
            /* Default = dark theme */
            --bg-body: #0f172a;
            --bg-card: linear-gradient(135deg, rgba(15,23,42,0.98), rgba(15,23,42,0.96));
            --bg-input: #020617;
            --header-bg: radial-gradient(circle at top left, rgba(56,189,248,0.25), transparent 55%);
            --footer-bg: rgba(15, 23, 42, 0.98);

            --accent: #38bdf8;
            --accent-soft: rgba(56, 189, 248, 0.1);
            --accent-strong: #0ea5e9;

            --text-main: #e5e7eb;
            --text-muted: #9ca3af;

            --user-bubble: #4ade80;
            --assistant-bubble: radial-gradient(circle at top left, rgba(15,23,42,0.95), rgba(17,24,39,0.98));

            --border-subtle: rgba(148, 163, 184, 0.35);
            --border-strong: rgba(55, 65, 81, 0.9);

            --chip-bg: transparent;
        }

        /* Light theme overrides */
        :root[data-theme="light"] {
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-input: #f1f5f9;
            --header-bg: linear-gradient(to right, #e0f2fe, #eff6ff);
           

            --text-main: #0f172a;
            --text-muted: #6b7280;

            --user-bubble: linear-gradient(135deg, #22c55e, #4ade80);
            --assistant-bubble: #e5e7eb;

            --border-subtle: rgba(148, 163, 184, 0.6);
            --border-strong: rgba(148, 163, 184, 0.8);

            --chip-bg: #e5f3ff;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
        }

        .page-wrap {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 24px 16px 64px;
        }

        .chat-container {
            width: 100%;
            max-width: 960px;
            background: var(--bg-card);
            border-radius: 24px;
            border: 1px solid var(--border-subtle);
            box-shadow:
                0 18px 45px rgba(15, 23, 42, 0.9),
                0 0 0 1px rgba(15, 23, 42, 0.9);
            overflow: hidden;
            backdrop-filter: blur(18px);
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .chat-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-strong);
            background: var(--header-bg);
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-logo {
            width: 55px;
            height: 60px;
            border-radius: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #020617;
            overflow: hidden;
        }

        .chat-logo img {
            max-height: 56px;
            width: auto;
            display: block;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.03em;
        }

        .chat-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .chat-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chip {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            background: var(--chip-bg);
        }

        .btn-secondary {
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            background: transparent;
            color: var(--text-main);
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .btn-secondary:hover {
            border-color: var(--accent-strong);
            color: var(--accent-strong);
        }

        /* Chat area */
        .chat-body {
            display: flex;
            flex-direction: column;
            padding: 12px 16px 8px;
            gap: 10px;
            height: 480px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .chat-body::-webkit-scrollbar { width: 6px; }
        .chat-body::-webkit-scrollbar-track { background: transparent; }
        .chat-body::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.7);
            border-radius: 999px;
        }

        .empty-state {
            margin: auto;
            text-align: center;
            color: var(--text-muted);
            max-width: 360px;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 13px;
            line-height: 1.5;
        }

        /* Message bubbles */
        .msg-row {
            display: flex;
            margin-bottom: 4px;
        }

        .msg-row.user { justify-content: flex-end; }
        .msg-row.assistant { justify-content: flex-start; }

        .avatar {
            width: 26px;
            height: 26px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .avatar-user {
            background: radial-gradient(circle at 30% 30%, #4ade80, #16a34a);
            color: #022c22;
            margin-left: 8px;
        }

        .avatar-assistant {
            background: radial-gradient(circle at 30% 30%, #38bdf8, #0ea5e9);
            color: #0b1120;
            margin-right: 8px;
        }

        .bubble-wrap {
            max-width: 82%;
            display: flex;
            flex-direction: column;
        }

        .bubble-meta {
            font-size: 10px;
            color: var(--text-muted);
            margin: 0 2px 2px;
        }

        .bubble {
            padding: 10px 12px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.45;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .bubble-user {
            background: var(--user-bubble);
            color: #022c22;
            border-bottom-right-radius: 4px;
            box-shadow: 0 3px 8px rgba(22, 163, 74, 0.35);
        }

        .bubble-assistant {
            background: var(--assistant-bubble);
            border: 1px solid var(--border-strong);
            border-bottom-left-radius: 4px;
            box-shadow: 0 3px 10px rgba(15,23,42,0.8);
        }

        /* Input area */
        .chat-input-area {
            border-top: 1px solid var(--border-strong);
            padding: 12px 16px 14px;
            background: radial-gradient(circle at bottom right, rgba(56,189,248,0.16), rgba(15,23,42,1) 48%);
        }

        :root[data-theme="light"] .chat-input-area {
            background: #f8fafc;
        }

        .input-row {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .input-wrapper {
            flex: 1;
            background: var(--bg-input);
            border-radius: 999px;
            border: 1px solid var(--border-strong);
            padding: 6px 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-wrapper:focus-within {
            border-color: var(--accent-strong);
            box-shadow: 0 0 0 1px rgba(56,189,248,0.4);
        }

        .input-pill-label {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            background: var(--accent-soft);
            color: var(--accent);
            border: 1px solid rgba(56,189,248,0.55);
        }

        textarea[name="prompt"] {
            background: transparent;
            border: none;
            resize: none;
            outline: none;
            color: var(--text-main);
            font-size: 14px;
            flex: 1;
            padding: 6px 0;
            max-height: 120px;
        }

        textarea[name="prompt"]::placeholder {
            color: rgba(148, 163, 184, 0.7);
        }

        .btn-primary {
            border: none;
            border-radius: 999px;
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.03em;
            cursor: pointer;
            background: radial-gradient(circle at 30% 0%, #38bdf8, #0ea5e9);
            color: #0b1120;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 8px 18px rgba(56,189,248,0.5);
            white-space: nowrap;
        }

        .btn-primary:hover {
            filter: brightness(1.06);
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(56,189,248,0.65);
        }

        .helper-text {
            margin-top: 6px;
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: wrap;
        }

        .helper-text span.key-hint {
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            font-size: 10px;
        }

        /* Footer */
        .footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: var(--footer-bg);
            color: #e5e7eb;
            text-align: center;
            padding: 6px 8px;
            font-size: 12px;
            border-top: 1px solid rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(12px);
        }

        @media (max-width: 768px) {
            .page-wrap {
                padding: 12px 8px 72px;
            }

            .chat-container {
                border-radius: 18px;
            }

            .chat-body {
                height: 420px;
            }

            .chat-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }

            .chat-header-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
        .action-buttons {
    float: right;
    display: flex;
    gap: 6px;
}

.action-buttons button {
    background: transparent;
    border: 1px solid var(--border-subtle);
    color: var(--text-muted);
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 999px;
    cursor: pointer;
}

.action-buttons button:hover {
    color: var(--accent-strong);
    border-color: var(--accent-strong);
}
/* ---------------- PDF WATERMARK ---------------- */
.pdf-watermark {
    display: none;              /* Hidden on screen */
}

/* ---------- PDF WATERMARK (html2pdf compatible) ---------- */
.pdf-watermark {
    display: none; /* hidden by default */
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-30deg);
    font-size: 64px;
    font-weight: 800;
    color: rgba(120, 120, 120, 0.15);
    z-index: 1000;
    pointer-events: none;
    white-space: nowrap;
}

/* Ensure parent allows overlay */
.solution-content {
    position: relative;
}

.pdf-watermark img {
    opacity: 0.25;
    margin-bottom: 10px;
}
/* ---------- SEND BUTTON (CIRCLE + UP ARROW) ---------- */
.send-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    background: radial-gradient(circle at 30% 30%, #38bdf8, #0ea5e9);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 18px rgba(56,189,248,0.45);
    transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
}

.send-btn:hover {
    filter: brightness(1.08);
    transform: translateY(-1px);
    box-shadow: 0 10px 22px rgba(56,189,248,0.6);
}

.send-btn:active {
    transform: scale(0.95);
    box-shadow: 0 4px 10px rgba(56,189,248,0.4);
}

.send-btn:focus-visible {
    outline: 2px solid var(--accent-strong);
    outline-offset: 3px;
}

.send-icon {
    width: 20px;
    height: 20px;
    fill: #0b1120; /* dark arrow for contrast */
}

/* Light theme arrow color tweak */
:root[data-theme="light"] .send-icon {
    fill: #0f172a;
}

/* ---------- CONTEXT BAR ---------- */
.context-bar{
    margin-top: 5px;
    background:var(--surface);
    border-bottom:1px solid var(--border);
    color:var(--text);
}
.guardrails{
    padding:14px 16px;
    border-bottom:1px solid var(--border);
}
.guardrail-row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
}
.guardrail-row select{
    flex:1;
    min-width:140px;
    padding:8px;
    border-radius:8px;
    background:var(--input);
    color:var(--text);
    border:1px solid var(--border);
}
.guardrails button{
    margin-top:10px;
    padding:10px 18px;
    border-radius:999px;
    background:var(--accent);
    color:#020617;
    border:none;
    cursor:pointer;
}
.guardrails button:disabled{opacity:.5}
/* ================= FIX: DROPDOWN VISIBILITY (DARK THEME) ================= */

/* Base select styling */
.guardrail-row select {
    background: var(--bg-input);
    color: var(--text-main);
}

/* Dropdown list items (critical fix) */
.guardrail-row select option {
    background: #ffffff;        /* light background for readability */
    color: #0f172a;             /* dark readable text */
}

/* Dark theme hover / selected state */
.guardrail-row select option:checked,
.guardrail-row select option:hover {
    background: #e0f2fe;
    color: #0f172a;
}

/* Firefox specific fix */
.guardrail-row select:-moz-focusring {
    color: transparent;
    text-shadow: 0 0 0 var(--text-main);
}
.start-chat-wrapper {
    display: flex;
    justify-content: center;
    margin-top: 12px;
}

    </style>
    
</head>
<body>
<div class="page-wrap">
    <div class="chat-container">
        <!-- Header -->
        <header class="chat-header">
            <div class="chat-header-left">
                <div class="chat-logo">
                    <img src="{% static 'school_app/images/pailogo.png' %}" alt="PAI Logo">
                </div>
                <div>
                    <div class="chat-title">PadhaiWithAI ‚Äì AI Study Sathi (Smart Tutor)</div>
                    <div class="chat-subtitle">Personal AI assistant for learning Class-wise ‚Ä¢ Subject-wise ‚Ä¢ Chapter-wise</div>
                </div>
            </div>
            <div class="chat-header-actions">
                <span class="chip">Chat ¬∑ S</span>
                <button type="button" class="btn-secondary" id="themeToggle"></button>
                <a href="?clear=1" class="btn-secondary" title="Start a fresh conversation">
                    ‚ü≤ New chat
                </a>
            </div>
        </header>
<!-- ================= GUARDRAILS ================= -->
 {% if guardrail %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("contextBar").style.display = "flex";
        document.getElementById("ctxClass").textContent = "{{ guardrail }}";
        document.getElementById("ctxSubject").textContent = "{{ request.session.subject }}";
        document.getElementById("ctxChapter").textContent = "{{ request.session.chapter }}";
    });
</script>
{% endif %}
<div class="guardrails" id="guardrailPanel"   {% if guardrail %}style="display:none"{% endif %}>
    <h4>Select learning context</h4>
    <p style="font-size:12px;color:var(--text-muted)">
        This helps AI answer strictly from your syllabus.
    </p>

    <div class="guardrail-row">
        <select id="classSelect">
            <option value="">Class</option>
            <option>6</option><option>7</option><option>8</option>
            <option>9</option><option>10</option><option>11</option><option>12</option>
        </select>

        <select id="subjectSelect" disabled>
            <option value="">Subject</option>
            <option>Math</option>
            <option>Science</option>
            <option>English</option>
            <option>Hindi</option>
            <option>Social Science</option>
            <option>Physics</option>
            <option>Chemistry</option>
            <option>Biology</option>
            <option>Computer Science</option>
            <option>Informatics Practices</option>
            <option>Accountancy</option>
            <option>Business Studies</option>
            <option>Economics</option>
            <option>Physical Education</option>
        </select>

        <select id="chapterSelect" disabled>
            <option value="">Chapter</option>
        </select>
    </div>

    <div class="start-chat-wrapper">
    <button id="startChatBtn" class="btn-primary" disabled>
        Start Chat
    </button>
</div>
</div>

<!-- ================= CONTEXT BAR ================= -->
<div class="context-bar" id="contextBar" style="display:none">
    <div class="context-left">
        <span class="chip">üîí Class <strong id="ctxClass"></strong></span>
        <span class="chip"><strong id="ctxSubject"></strong></span>
        <span class="chip"><strong id="ctxChapter"></strong></span>
    </div>

    <a href="?clear=1" class="btn-secondary">‚ü≤ Reset</a>
    
</div>

        <!-- Chat history -->
        <main class="chat-body" id="chat-body">
            {% if history %}
                {% for msg in history %}
                    {% if msg.role == "user" %}
                        <div class="msg-row user">
                            <div class="bubble-wrap">
                                <div class="bubble-meta">You</div>
                                <div class="bubble bubble-user">{{ msg.content }}
                                    <button onclick="speakText(this)" class="btn-secondary">üîä Listen</button>
                                </div>
                                
                            </div>
                            <div class="avatar avatar-user">U</div>
                        </div>
                    {% else %}
                            <div class="msg-row assistant">
                                <div class="avatar avatar-assistant"><img src="{% static 'school_app/images/pailogo.png' %}" width="25"></div>
                                <div class="bubble-wrap">
                                    <div class="bubble-meta">
                                        PAI Assistant
                                        <span class="action-buttons">                                           
                                            <button onclick="downloadPDF(this)">üìÑ PDF</button>
                                            <button onclick="regenerateSolution(this)">üîÅ Regenerate</button>
                                            
                                        </span>
                                    </div>
                                    <div class="bubble bubble-assistant solution-content">
                                        <div class="pdf-watermark">
                                            <img src="{% static 'school_app/images/pailogo.png' %}" width="250"><br>PadhaiWithAI</div>
                                        {{ msg.content }}
                                        <button onclick="speakText(this)" class="btn-secondary">
    üîä Listen / ‚èπ Stop
</button>
                                    </div>
                                </div>
                            </div>

                    {% endif %}
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <h3>Welcome to PadhaiWithAI AI Study Sathi</h3>
                    <p>Select learning context from the above 
                        Class-wise -> Subject-wise -> Chapter-wise </p>
                     <p>   Ask questions about or anything you‚Äôre curious about. </p> 
                       <p>Your conversation will appear here as you start chatting.</p>
                    <p>Start a conversation by typing below!</p>
                </div>
            {% endif %}
        </main>

        <!-- Input -->
        <form method="post" class="chat-input-area">
            {% csrf_token %}
            <div class="input-row">
                <div class="input-wrapper">
                    <!-- <span class="input-pill-label">Prompt</span> -->
                    <!-- <textarea name="prompt" id="chatPrompt"
                              rows="1"
                              placeholder="Ask a maths doubt, explain a concept, or say ‚Äòhelp me solve this equation‚Ä¶‚Äô"
                              required></textarea> -->
                    <textarea name="prompt" id="chatPrompt"           rows="1"           placeholder="{% if guardrail %}Ask your question‚Ä¶{% else %}Select Class, Subject & Chapter first‚Ä¶{% endif %}"
         {% if not guardrail %}disabled{% endif %}           required></textarea>
                </div>
               
                <button type="submit" class="send-btn" aria-label="Send message">    
                    <svg viewBox="0 0 24 24" class="send-icon" aria-hidden="true">
                      <path d="M12 4l6 6h-4v6h-4v-6H6z"></path>
                          </svg>
                    </button>
            </div>
            <div class="helper-text">
                <span>Try: ‚ÄúExplain Real Numbers for class 10 with examples.‚Äù</span>
                <span class="key-hint">Your chat is not stored permanently.</span>
                <!-- <span class="key-hint">Math formulas support LaTeX: like $a^2 + b^2$.</span> -->
            </div>
            <input type="hidden" name="class_level" id="class_level">
            <input type="hidden" name="subject" id="subject">
            <input type="hidden" name="chapter" id="chapter">
        </form>
    </div>
</div>

<div class="footer">
    PadhaiWithAI ‚Äì Tonk, Rajasthan
</div>
<script>
(function () {
    const textarea = document.getElementById('chatPrompt');
    const form = textarea.closest('form');

    textarea.addEventListener('keydown', function (e) {
        // ENTER ‚Üí submit
        if (e.key === 'Enter' && !e.altKey) {
            e.preventDefault(); // stop newline
            form.submit();
        }

        // ALT + ENTER ‚Üí new line
        if (e.key === 'Enter' && e.altKey) {
            e.preventDefault();
            const start = this.selectionStart;
            const end = this.selectionEnd;
            this.value = this.value.substring(0, start) + "\n" + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 1;
        }
    });

    // Auto-grow textarea height (optional but recommended)
    textarea.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });
})();
</script>

<script>

    
    // Auto-scroll to bottom on load so latest messages are visible
    const chatBody = document.getElementById('chat-body');
    if (chatBody) {
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    // Theme toggle with localStorage
    (function() {
        const root = document.documentElement;
        const toggle = document.getElementById('themeToggle');

        function setLabel(theme) {
            if (!toggle) return;
            if (theme === 'light') {
                toggle.textContent = 'üåô Dark mode';
            } else {
                toggle.textContent = '‚òÄÔ∏è Light mode';
            }
        }

        const saved = localStorage.getItem('pai-theme') || 'light';
        root.setAttribute('data-theme', saved);
        setLabel(saved);

        if (toggle) {
            toggle.addEventListener('click', () => {
                const current = root.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
                const next = current === 'light' ? 'dark' : 'light';
                root.setAttribute('data-theme', next);
                localStorage.setItem('pai-theme', next);
                setLabel(next);
            });
        }
    })();

    // Ensure MathJax typesets after load
    window.addEventListener('load', () => {
        if (window.MathJax && window.MathJax.typesetPromise) {
            window.MathJax.typesetPromise();
        }
    });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
function downloadPDF(btn) {
    const solution = btn.closest('.bubble-wrap')
        .querySelector('.solution-content');

    const watermark = solution.querySelector('.pdf-watermark');

    // 1Ô∏è‚É£ Show watermark before PDF render
    if (watermark) {
        watermark.style.display = 'block';
    }

    const opt = {
        margin: 10,
        filename: 'PadhaiWithAI_Solution.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
            scale: 2,
            useCORS: true
        },
        jsPDF: {
            unit: 'mm',
            format: 'a4',
            orientation: 'portrait'
        }
    };

    html2pdf().from(solution).set(opt).save().then(() => {
        // 2Ô∏è‚É£ Hide watermark again after download
        if (watermark) {
            watermark.style.display = 'none';
        }
    });
}
</script>


<script>
function regenerateSolution(btn) {
    const userQuestion = btn.closest('.msg-row')
        .previousElementSibling
        .querySelector('.bubble-user').innerText;

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '';

    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;

    form.innerHTML = `
        <input type="hidden" name="csrfmiddlewaretoken" value="${csrf}">
        <input type="hidden" name="prompt" value="Explain again with different steps: ${userQuestion}">
    `;

    document.body.appendChild(form);
    form.submit();
}
</script>
<script>
const chapters = {

  "6": {
    "Math": [
      "Knowing Our Numbers","Whole Numbers","Playing with Numbers","Basic Geometrical Ideas",
      "Understanding Elementary Shapes","Integers","Fractions","Decimals","Data Handling",
      "Mensuration","Algebra","Ratio and Proportion","Symmetry","Practical Geometry"
    ],
    "Science": [
      "Food: Where Does It Come From?","Components of Food","Fibre to Fabric",
      "Sorting Materials into Groups","Separation of Substances","Changes Around Us",
      "Getting to Know Plants","Body Movements","The Living Organisms and Their Surroundings",
      "Motion and Measurement of Distances","Light, Shadows and Reflections",
      "Electricity and Circuits","Fun with Magnets"
    ],
    "English": [
      "Who Did Patrick‚Äôs Homework","How the Dog Found Himself","Taro‚Äôs Reward",
      "An Indian-American Woman in Space","A Different Kind of School","Who I Am",
      "Fair Play","A Game of Chance","Desert Animals","The Banyan Tree"
    ],
    "Hindi": [
      "‡§µ‡§π ‡§ö‡§ø‡§°‡§º‡§ø‡§Ø‡§æ ‡§ú‡•ã","‡§¨‡§ö‡§™‡§®","‡§®‡§æ‡§¶‡§æ‡§® ‡§¶‡•ã‡§∏‡•ç‡§§","‡§ö‡§æ‡§Å‡§¶ ‡§∏‡•á ‡§•‡•ã‡§°‡§º‡•Ä-‡§∏‡•Ä ‡§ó‡§™‡•ç‡§™‡•á‡§Ç",
      "‡§Ö‡§ï‡•ç‡§∑‡§∞‡•ã‡§Ç ‡§ï‡§æ ‡§Æ‡§π‡§§‡•ç‡§µ","‡§™‡§æ‡§∞ ‡§®‡§ú‡§º‡§∞ ‡§ï‡•á","‡§∏‡§æ‡§•‡•Ä ‡§π‡§æ‡§• ‡§¨‡§¢‡§º‡§æ‡§®‡§æ"
    ],
    "Social Science": [
      "History: What, Where, How and When","From Hunting-Gathering to Growing Food",
      "In the Earliest Cities","What Books and Burials Tell Us",
      "Kingdoms, Kings and an Early Republic",
      "Geography: The Earth in the Solar System","Globe: Latitudes and Longitudes",
      "Civics: Understanding Diversity","Diversity and Discrimination"
    ]
  },

  "7": {
    "Math": [
      "Integers","Fractions and Decimals","Data Handling","Simple Equations",
      "Lines and Angles","The Triangle and Its Properties","Congruence of Triangles",
      "Comparing Quantities","Rational Numbers","Practical Geometry",
      "Perimeter and Area","Algebraic Expressions","Exponents and Powers",
      "Symmetry","Visualising Solid Shapes"
    ],
    "Science": [
      "Nutrition in Plants","Nutrition in Animals","Fibre to Fabric","Heat",
      "Acids, Bases and Salts","Physical and Chemical Changes",
      "Respiration in Organisms","Transportation in Animals and Plants",
      "Reproduction in Plants","Motion and Time","Electric Current and Its Effects",
      "Light","Forests: Our Lifeline","Wastewater Story"
    ],
    "English": [
      "Three Questions","A Gift of Chappals","Gopal and the Hilsa Fish",
      "The Ashes That Made Trees Bloom","Quality",
      "Expert Detectives","The Invention of Vita-Wonk"
    ],
    "Hindi": [
      "‡§π‡§Æ ‡§™‡§Ç‡§õ‡•Ä ‡§â‡§®‡•ç‡§Æ‡•Å‡§ï‡•ç‡§§ ‡§ó‡§ó‡§® ‡§ï‡•á","‡§¶‡§æ‡§¶‡•Ä ‡§Æ‡§æ‡§Å","‡§π‡§ø‡§Æ‡§æ‡§≤‡§Ø ‡§ï‡•Ä ‡§¨‡•á‡§ü‡§ø‡§Ø‡§æ‡§Å",
      "‡§ï‡§Ç‡§ö‡§æ","‡§Æ‡•Ä‡§†‡§æ‡§à‡§µ‡§æ‡§≤‡§æ","‡§∞‡§ï‡•ç‡§§ ‡§î‡§∞ ‡§π‡§Æ‡§æ‡§∞‡§æ ‡§∂‡§∞‡•Ä‡§∞"
    ],
    "Social Science": [
      "Tracing Changes Through a Thousand Years","New Kings and Kingdoms",
      "Environment","Inside Our Earth",
      "On Equality","Role of the Government in Health"
    ]
  },

  "8": {
    "Math": [
      "Rational Numbers","Linear Equations in One Variable","Understanding Quadrilaterals",
      "Practical Geometry","Data Handling","Squares and Square Roots",
      "Cubes and Cube Roots","Comparing Quantities",
      "Algebraic Expressions and Identities","Visualising Solid Shapes",
      "Mensuration","Exponents and Powers","Direct and Inverse Proportions",
      "Factorisation","Introduction to Graphs","Playing with Numbers"
    ],
    "Science": [
      "Crop Production and Management","Microorganisms: Friend and Foe",
      "Synthetic Fibres and Plastics","Materials: Metals and Non-Metals",
      "Coal and Petroleum","Combustion and Flame",
      "Cell ‚Äì Structure and Functions","Reproduction in Animals",
      "Reaching the Age of Adolescence","Force and Pressure","Friction",
      "Sound","Chemical Effects of Electric Current",
      "Some Natural Phenomena","Conservation of Plants and Animals"
    ],
    "English": [
      "The Best Christmas Present","The Tsunami","Glimpses of the Past",
      "Bepin Choudhury‚Äôs Lapse of Memory","The Summit Within"
    ],
    "Hindi": [
      "‡§ß‡•ç‡§µ‡§®‡§ø","‡§≤‡§æ‡§ñ ‡§ï‡•Ä ‡§ö‡•Ç‡§°‡§º‡§ø‡§Ø‡§æ‡§Å","‡§¨‡§∏ ‡§ï‡•Ä ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ",
      "‡§¶‡•Ä‡§µ‡§æ‡§®‡•ã‡§Ç ‡§ï‡•Ä ‡§π‡§∏‡•ç‡§§‡•Ä","‡§ö‡§ø‡§ü‡•ç‡§†‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§Ö‡§®‡•Ç‡§†‡•Ä ‡§¶‡•Å‡§®‡§ø‡§Ø‡§æ"
    ],
    "Social Science": [
      "How, When and Where","The British Took Control",
      "Resources","Agriculture",
      "The Indian Constitution","Understanding Secularism"
    ]
  },

  "9": {
    "Math": [
      "Number Systems","Polynomials","Coordinate Geometry",
      "Linear Equations in Two Variables","Introduction to Euclid‚Äôs Geometry",
      "Lines and Angles","Triangles","Quadrilaterals",
      "Areas of Parallelograms and Triangles","Circles","Constructions",
      "Heron‚Äôs Formula","Surface Areas and Volumes",
      "Statistics","Probability"
    ],
    "Science": [
      "Matter in Our Surroundings","Is Matter Around Us Pure",
      "Atoms and Molecules","Structure of the Atom",
      "The Fundamental Unit of Life","Tissues",
      "Diversity in Living Organisms","Why Do We Fall Ill",
      "Natural Resources","Improvement in Food Resources",
      "Motion","Force and Laws of Motion","Gravitation",
      "Work and Energy","Sound"
    ],
    "English": [
      "The Fun They Had","The Sound of Music","The Little Girl",
      "A Truly Beautiful Mind","My Childhood","Packing","Reach for the Top"
    ],
    "Hindi": [
      "‡§¶‡•ã ‡§¨‡•à‡§≤‡•ã‡§Ç ‡§ï‡•Ä ‡§ï‡§•‡§æ","‡§≤‡•ç‡§π‡§æ‡§∏‡§æ ‡§ï‡•Ä ‡§ì‡§∞","‡§â‡§™‡§≠‡•ã‡§ï‡•ç‡§§‡§æ‡§µ‡§æ‡§¶ ‡§ï‡•Ä ‡§∏‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§ø",
      "‡§∏‡§æ‡§Å‡§µ‡§≤‡•á ‡§∏‡§™‡§®‡•ã‡§Ç ‡§ï‡•Ä ‡§Ø‡§æ‡§¶","‡§®‡§æ‡§®‡§æ ‡§∏‡§æ‡§π‡§¨ ‡§ï‡•Ä ‡§™‡•Å‡§§‡•ç‡§∞‡•Ä ‡§¶‡•á‡§µ‡•Ä ‡§Æ‡•à‡§®‡§æ"
    ],
    "Social Science": [
      "The French Revolution","Socialism in Europe",
      "India ‚Äì Size and Location","Physical Features of India",
      "What is Democracy","Constitutional Design"
    ]
  },

  "10": {
    "Math": [
      "Real Numbers","Polynomials","Pair of Linear Equations in Two Variables",
      "Quadratic Equations","Arithmetic Progressions","Triangles",
      "Coordinate Geometry","Trigonometry","Applications of Trigonometry",
      "Circles","Constructions","Areas Related to Circles",
      "Surface Areas and Volumes","Statistics","Probability"
    ],
    "Science": [
      "Chemical Reactions and Equations","Acids, Bases and Salts",
      "Metals and Non-Metals","Carbon and Its Compounds",
      "Life Processes","Control and Coordination",
      "How Do Organisms Reproduce","Heredity and Evolution",
      "Environment","Management of Natural Resources",
      "Light ‚Äì Reflection and Refraction",
      "The Human Eye and the Colourful World",
      "Electricity","Magnetic Effects of Electric Current",
      "Sources of Energy"
    ]
  },

  "11": {
    "Physics": [
      "Physical World and Measurement","Kinematics","Laws of Motion",
      "Work, Energy and Power","Motion of System of Particles and Rigid Body",
      "Gravitation","Properties of Bulk Matter","Thermodynamics",
      "Behaviour of Perfect Gas and Kinetic Theory","Oscillations and Waves"
    ],
    "Chemistry": [
      "Some Basic Concepts of Chemistry","Structure of Atom",
      "Classification of Elements and Periodicity",
      "Chemical Bonding and Molecular Structure","States of Matter",
      "Thermodynamics","Equilibrium","Redox Reactions","Hydrogen",
      "The s-Block Element","Organic Chemistry ‚Äì Basic Principles",
      "Hydrocarbons","Environmental Chemistry"
    ],
    "Biology": [
      "The Living World","Biological Classification","Plant Kingdom",
      "Animal Kingdom","Morphology of Flowering Plants",
      "Anatomy of Flowering Plants","Structural Organisation in Animals",
      "Cell: Structure and Function","Biomolecules","Cell Cycle and Cell Division",
      "Transport in Plants","Mineral Nutrition","Photosynthesis",
      "Respiration in Plants","Plant Growth and Development"
    ],
    "Math": [
      "Sets","Relations and Functions","Trigonometric Functions",
      "Principle of Mathematical Induction",
      "Complex Numbers and Quadratic Equations",
      "Linear Inequalities","Permutations and Combinations",
      "Binomial Theorem","Sequences and Series","Straight Lines",
      "Conic Sections","Introduction to Three Dimensional Geometry",
      "Limits and Derivatives","Mathematical Reasoning",
      "Statistics","Probability"
    ]
  },

  "12": {
    "Math": [
      "Relations and Functions","Inverse Trigonometric Functions",
      "Matrices","Determinants","Continuity and Differentiability",
      "Applications of Derivatives","Integrals","Applications of Integrals",
      "Differential Equations","Vector Algebra",
      "Three Dimensional Geometry","Linear Programming","Probability"
    ],
    "Physics": [
      "Electrostatics","Current Electricity",
      "Magnetic Effects of Current and Magnetism",
      "Electromagnetic Induction","Alternating Current",
      "Electromagnetic Waves","Ray Optics","Wave Optics",
      "Dual Nature of Radiation and Matter",
      "Atoms","Nuclei","Semiconductor Electronics"
    ],
    "Chemistry": [
      "Solid State","Solutions","Electrochemistry","Chemical Kinetics",
      "Surface Chemistry","General Principles of Metallurgy",
      "p-Block Elements","d- and f-Block Elements",
      "Coordination Compounds","Haloalkanes and Haloarenes",
      "Alcohols, Phenols and Ethers",
      "Aldehydes, Ketones and Carboxylic Acids",
      "Amines","Biomolecules","Polymers",
      "Chemistry in Everyday Life"
    ],
    "Biology": [
      "Reproduction in Organisms","Sexual Reproduction in Flowering Plants",
      "Human Reproduction","Reproductive Health",
      "Principles of Inheritance and Variation",
      "Molecular Basis of Inheritance","Evolution",
      "Human Health and Disease",
      "Strategies for Enhancement in Food Production",
      "Microbes in Human Welfare",
      "Biotechnology: Principles and Processes",
      "Biotechnology and Its Applications",
      "Organisms and Populations","Ecosystem",
      "Biodiversity and Conservation","Environmental Issues"
    ]
  }

};


/* ================= GUARDRAIL LOGIC ================= */
const cls = document.getElementById("classSelect");
const sub = document.getElementById("subjectSelect");
const ch  = document.getElementById("chapterSelect");
const btn = document.getElementById("startChatBtn");
const prompt = document.getElementById("chatPrompt");

cls.onchange = () => {
    sub.disabled = !cls.value;
    ch.disabled = true;
    btn.disabled = true;
};

sub.onchange = () => {
    ch.disabled = false;
    ch.innerHTML = "<option value=''>Chapter</option>";
    (chapters[cls.value]?.[sub.value] || []).forEach(c => {
        const opt = document.createElement("option");
        opt.textContent = c;
        ch.appendChild(opt);
    });
};

ch.onchange = () => btn.disabled = !ch.value;

btn.onclick = () => {
    document.getElementById("guardrailPanel").style.display = "none";

    cls.disabled = true;
    sub.disabled = true;
    ch.disabled  = true;

    // Enable chat
    prompt.disabled = false;
    prompt.placeholder = "Ask your question‚Ä¶";

    // Auto-prompt (UX boost)
    prompt.value = `Explain "${ch.value}" for Class ${cls.value} ${sub.value} with examples and steps.`;
    document.getElementById("class_level").value = cls.value;
    document.getElementById("subject").value = sub.value;
    document.getElementById("chapter").value = ch.value;
    // Context bar
    document.getElementById("ctxClass").textContent = cls.value;
    document.getElementById("ctxSubject").textContent = sub.value;
    document.getElementById("ctxChapter").textContent = ch.value;
    document.getElementById("contextBar").style.display = "flex";

    prompt.focus();
};
</script>
<script>
let currentUtterance = null;
let isSpeaking = false;

function speakText(btn) {
    const text = btn.closest(".bubble").innerText.trim();

    // If already speaking ‚Üí STOP
    if (isSpeaking) {
        speechSynthesis.cancel();
        isSpeaking = false;
        currentUtterance = null;
        return;
    }

    // Detect language
    const lang = detectLanguage(text);

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = lang;
    utterance.rate = 0.9;
    utterance.pitch = 1;

    utterance.onstart = () => {
        isSpeaking = true;
        currentUtterance = utterance;
    };

    utterance.onend = () => {
        isSpeaking = false;
        currentUtterance = null;
    };

    utterance.onerror = () => {
        isSpeaking = false;
        currentUtterance = null;
    };

    // Ensure clean start
    speechSynthesis.cancel();
    speechSynthesis.speak(utterance);
}

/* ---------- LANGUAGE DETECTION (UNCHANGED) ---------- */
function detectLanguage(text) {
    const patterns = {
        'hi-IN': /[\u0900-\u097F]/,
        'bn-IN': /[\u0980-\u09FF]/,
        'ta-IN': /[\u0B80-\u0BFF]/,
        'te-IN': /[\u0C00-\u0C7F]/,
        'mr-IN': /[\u0900-\u097F]/,
        'gu-IN': /[\u0A80-\u0AFF]/,
        'kn-IN': /[\u0C80-\u0CFF]/,
        'ml-IN': /[\u0D00-\u0D7F]/,
        'pa-IN': /[\u0A00-\u0A7F]/,
        'or-IN': /[\u0B00-\u0B7F]/,
        'as-IN': /[\u0980-\u09FF]/,
        'ur-PK': /[\u0600-\u06FF]/,
        'zh-CN': /[\u4E00-\u9FFF]/,
        'ja-JP': /[\u3040-\u309F\u30A0-\u30FF]/,
        'ko-KR': /[\uAC00-\uD7AF]/,
        'ar-SA': /[\u0600-\u06FF]/,
        'es-ES': /[√°√©√≠√≥√∫√±√º¬ø¬°]/i,
        'fr-FR': /[√†√¢√¶√ß√©√®√™√´√Ø√Æ√¥≈ì√π√ª√º√ø]/i,
        'de-DE': /[√§√∂√º√ü]/i,
        'pt-PT': /[√†√°√¢√£√ß√©√™√≠√≥√¥√µ√∫]/i,
        'ru-RU': /[\u0400-\u04FF]/,
        'it-IT': /[√†√®√©√¨√≤√π]/i,
        'th-TH': /[\u0E00-\u0E7F]/,
        'vi-VN': /[√†√°·∫£√£·∫°ƒÉ·∫±·∫Ø·∫≥·∫µ·∫∑√¢·∫ß·∫•·∫©·∫´·∫≠ƒë√®√©·∫ª·∫Ω·∫π√™·ªÅ·∫ø·ªÉ·ªÖ·ªá]/i,
        'tr-TR': /[√ßƒüƒ±ƒ∞√∂≈ü√º]/i,
        'pl-PL': /[ƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]/i,
        'sv-SE': /[√•√§√∂]/i,
    };

    for (const [locale, pattern] of Object.entries(patterns)) {
        if (pattern.test(text)) {
            return locale;
        }
    }
    return 'en-IN';
}
</script>


<script>
document.addEventListener("DOMContentLoaded", () => {
    const textarea = document.getElementById("chatPrompt");
    const form = textarea.closest("form");

    textarea.addEventListener("keydown", function(e){
        if (e.key === "Enter" && !e.altKey) {
            e.preventDefault();      // prevent newline
            form.requestSubmit();   // submit form
        }
        // Alt + Enter ‚Üí new line (default behavior)
    });
});
</script>


</body>
</html>
